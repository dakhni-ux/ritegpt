<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RiteGPT - AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        rite: {
                            light: '#ffffff',
                            dark: '#0f172a', /* Slate 900 */
                            sidebar: '#f8fafc',
                            sidebarDark: '#1e293b', /* Slate 800 */
                            input: '#f1f5f9',
                            inputDark: '#334155',
                            accent: '#6366f1', /* Indigo 500 */
                            user: '#e0e7ff',
                            userDark: '#312e81'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Core Layout Fixes */
        html, body { height: 100%; overflow: hidden; }
        
        /* Markdown Styles */
        .markdown-body p { margin-bottom: 0.75rem; line-height: 1.6; }
        .markdown-body pre { 
            background: #1e1e1e; color: #d4d4d4; padding: 1rem; 
            border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0;
        }
        .markdown-body code { 
            background: rgba(127, 127, 127, 0.2); padding: 0.2rem 0.4rem; 
            border-radius: 0.25rem; font-family: monospace; font-size: 0.9em;
        }
        .markdown-body pre code { background: transparent; padding: 0; color: inherit; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; }
        .markdown-body ol { list-style-type: decimal; margin-left: 1.5rem; }
        .markdown-body blockquote { border-left: 4px solid #6366f1; padding-left: 1rem; color: #666; font-style: italic; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Typing cursor */
        .cursor-blink {
            display: inline-block; width: 6px; height: 1.2em;
            background-color: currentColor;
            animation: blink 1s step-end infinite; vertical-align: text-bottom;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-rite-dark text-slate-900 dark:text-slate-100 transition-colors duration-200 font-sans">

    <div id="loading" class="fixed inset-0 z-[60] flex items-center justify-center bg-white dark:bg-rite-dark">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-slate-500 font-medium tracking-wide">RiteGPT</p>
        </div>
    </div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-slate-50 dark:bg-rite-dark hidden">
        <div class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 animate-slide-up border border-slate-200 dark:border-slate-700">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900/50 mb-4">
                    <i class="ph ph-robot text-3xl text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Welcome to RiteGPT</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">Your intelligent workspace.</p>
            </div>

            <form id="login-form" class="space-y-4" onsubmit="auth.handleLogin(event)">
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">Username</label>
                    <input type="text" id="login-username" required class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 outline-none transition-all">
                </div>
                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition-colors shadow-lg shadow-indigo-500/30">
                    Log In
                </button>
                <p class="text-center text-sm text-slate-500 mt-4">
                    New here? <a href="#" onclick="auth.toggleView()" class="text-indigo-600 font-medium hover:underline">Create Account</a>
                </p>
            </form>

            <form id="register-form" class="space-y-4 hidden" onsubmit="auth.handleRegister(event)">
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">Choose Username</label>
                    <input type="text" id="reg-username" required class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">Choose Password</label>
                    <input type="password" id="reg-password" required class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 outline-none transition-all">
                </div>
                <button type="submit" class="w-full py-3 bg-slate-800 dark:bg-slate-600 hover:bg-slate-900 dark:hover:bg-slate-500 text-white font-semibold rounded-xl transition-colors">
                    Sign Up
                </button>
                <p class="text-center text-sm text-slate-500 mt-4">
                    Already have an account? <a href="#" onclick="auth.toggleView()" class="text-indigo-600 font-medium hover:underline">Log In</a>
                </p>
            </form>
            
            <div id="auth-error" class="mt-4 text-center text-red-500 text-sm hidden"></div>
        </div>
    </div>

    <div id="app" class="flex h-full w-full hidden opacity-0 transition-opacity duration-500">
        
        <aside id="sidebar" class="
            fixed inset-y-0 left-0 z-30 w-72 transform -translate-x-full transition-transform duration-300 ease-in-out
            md:relative md:translate-x-0 md:w-80
            bg-rite-sidebar dark:bg-rite-sidebarDark flex flex-col border-r border-slate-200 dark:border-slate-800
        ">
            <div class="p-4 border-b border-slate-200 dark:border-slate-800">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg" id="user-avatar">
                        U
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-sm truncate" id="display-username">Username</h3>
                        <p class="text-xs text-slate-500">Free Plan</p>
                    </div>
                </div>

                <button onclick="app.createNewChat()" class="w-full flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 rounded-lg transition-all text-sm font-medium text-slate-700 dark:text-slate-200 shadow-sm">
                    <i class="ph ph-plus text-lg"></i>
                    <span>New Chat</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar px-2 py-2 space-y-1" id="chat-history-list">
                </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800 space-y-1">
                <button onclick="app.toggleSettings()" class="flex items-center gap-3 w-full px-3 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700/50 rounded-lg transition-colors">
                    <i class="ph ph-gear text-lg"></i>
                    <span>Settings</span>
                </button>
                <button onclick="auth.logout()" class="flex items-center gap-3 w-full px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                    <i class="ph ph-sign-out text-lg"></i>
                    <span>Log Out</span>
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-slate-900/50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <main class="flex-1 flex flex-col h-full relative min-w-0 bg-white dark:bg-rite-dark">
            
            <header class="md:hidden flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800 bg-white/90 dark:bg-rite-dark/90 backdrop-blur sticky top-0 z-10">
                <button onclick="app.toggleSidebar()" class="p-2 -ml-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <span class="font-bold text-sm tracking-tight text-indigo-600 dark:text-indigo-400">RiteGPT</span>
                <button onclick="app.createNewChat()" class="p-2 -mr-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">
                    <i class="ph ph-plus text-xl"></i>
                </button>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-0 animate-fade-in p-6">
                    <div class="w-16 h-16 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-2xl mb-6 shadow-xl shadow-indigo-500/20 flex items-center justify-center">
                        <i class="ph ph-sparkle text-3xl text-white"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-3">Hello, <span id="welcome-user">User</span>.</h1>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md">I'm RiteGPT. Ready to help you create, code, and explore.</p>
                </div>
                
                <div id="messages-list" class="flex flex-col gap-6 max-w-3xl mx-auto pb-4">
                    </div>
            </div>

            <div class="p-4 md:p-6 bg-gradient-to-t from-white via-white to-transparent dark:from-rite-dark dark:via-rite-dark z-10">
                <div class="max-w-3xl mx-auto relative">
                    <div id="error-toast" class="hidden absolute -top-14 left-0 right-0 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-4 py-2 rounded-lg text-sm text-center mb-2 border border-red-200 dark:border-red-800 shadow-sm"></div>

                    <div class="relative bg-rite-input dark:bg-rite-inputDark rounded-3xl border border-transparent focus-within:border-indigo-300 dark:focus-within:border-indigo-700 transition-all shadow-sm">
                        <textarea 
                            id="user-input" 
                            rows="1" 
                            class="w-full bg-transparent text-slate-900 dark:text-slate-100 placeholder-slate-500 px-6 py-4 pr-14 rounded-3xl focus:outline-none resize-none overflow-hidden max-h-48"
                            placeholder="Message RiteGPT..."
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            onkeydown="app.handleEnter(event)"
                        ></textarea>
                        
                        <button 
                            onclick="app.sendMessage()" 
                            id="send-btn"
                            class="absolute right-2 bottom-2 p-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
                        >
                            <i class="ph ph-paper-plane-right text-lg"></i>
                        </button>
                    </div>
                    <div class="text-center mt-2 flex justify-center items-center gap-2">
                         <span class="text-[10px] uppercase tracking-wider text-slate-400" id="model-display">Model: DeepSeek-R1</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="app.toggleSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 border border-slate-200 dark:border-slate-700 animate-slide-up">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-900 dark:text-white">
                <i class="ph ph-sliders text-indigo-500"></i> Settings
            </h2>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">OpenRouter API Key</label>
                    <input type="password" id="setting-api-key" placeholder="sk-or-..." class="w-full px-4 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 transition-all outline-none">
                    <p class="text-xs text-slate-500 mt-1">Stored securely on your device for this account only.</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Model Name</label>
                    <input type="text" id="setting-model" placeholder="deepseek/deepseek-r1:free" class="w-full px-4 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 transition-all outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">System Prompt</label>
                    <textarea id="setting-system" rows="3" placeholder="You are RiteGPT..." class="w-full px-4 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-600 transition-all outline-none resize-none"></textarea>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Dark Mode</span>
                    <button onclick="app.toggleTheme()" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                        <i id="theme-icon" class="ph ph-moon text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                <button onclick="app.toggleSettings()" class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors text-sm font-medium">Cancel</button>
                <button onclick="app.saveSettings()" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium text-sm shadow-lg shadow-indigo-500/20">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const AppConfig = {
            DEFAULT_MODEL: 'deepseek/deepseek-r1:free',
            API_URL: 'https://openrouter.ai/api/v1/chat/completions',
            DEFAULT_SYSTEM: 'You are RiteGPT, a helpful, smart, and efficient AI assistant.'
        };

        // --- AUTHENTICATION MANAGER ---
        class AuthManager {
            constructor() {
                this.usersKey = 'ritegpt_users'; // Stores { username: { password: "..." } }
                this.sessionKey = 'ritegpt_session'; // Stores current username
                this.elements = {
                    authScreen: document.getElementById('auth-screen'),
                    app: document.getElementById('app'),
                    loader: document.getElementById('loading'),
                    loginForm: document.getElementById('login-form'),
                    registerForm: document.getElementById('register-form'),
                    authError: document.getElementById('auth-error')
                };
            }

            init() {
                // Check session
                const currentUser = localStorage.getItem(this.sessionKey);
                setTimeout(() => {
                    this.elements.loader.style.display = 'none';
                    if (currentUser) {
                        this.startApp(currentUser);
                    } else {
                        this.showAuth();
                    }
                }, 600);
            }

            getUsers() {
                return JSON.parse(localStorage.getItem(this.usersKey) || '{}');
            }

            handleRegister(e) {
                e.preventDefault();
                const username = document.getElementById('reg-username').value.trim().toLowerCase();
                const password = document.getElementById('reg-password').value;

                if (username.length < 3) return this.showError('Username must be at least 3 chars.');
                if (password.length < 3) return this.showError('Password too short.');

                const users = this.getUsers();
                if (users[username]) {
                    return this.showError('Username already taken.');
                }

                // Create User
                users[username] = { password: password, created: Date.now() }; // In real app, hash password!
                localStorage.setItem(this.usersKey, JSON.stringify(users));
                
                // Auto Login
                this.setSession(username);
            }

            handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value.trim().toLowerCase();
                const password = document.getElementById('login-password').value;

                const users = this.getUsers();
                
                if (!users[username] || users[username].password !== password) {
                    return this.showError('Invalid username or password.');
                }

                this.setSession(username);
            }

            setSession(username) {
                localStorage.setItem(this.sessionKey, username);
                this.startApp(username);
            }

            startApp(username) {
                this.elements.authScreen.classList.add('hidden');
                this.elements.app.classList.remove('hidden');
                
                // Trigger animation
                setTimeout(() => this.elements.app.style.opacity = '1', 50);
                
                // Initialize Chat App with specific user context
                window.app.initializeUser(username);
            }

            logout() {
                localStorage.removeItem(this.sessionKey);
                window.location.reload();
            }

            showAuth() {
                this.elements.authScreen.classList.remove('hidden');
                this.elements.loginForm.classList.remove('hidden');
                this.elements.registerForm.classList.add('hidden');
                this.elements.authError.classList.add('hidden');
            }

            toggleView() {
                this.elements.loginForm.classList.toggle('hidden');
                this.elements.registerForm.classList.toggle('hidden');
                this.elements.authError.classList.add('hidden');
            }

            showError(msg) {
                this.elements.authError.innerText = msg;
                this.elements.authError.classList.remove('hidden');
            }
        }

        // --- CHAT APPLICATION ---
        class ChatApp {
            constructor() {
                this.username = null;
                this.storageKey = null; // Will be 'ritegpt_data_username'
                this.state = {
                    chats: [],
                    currentChatId: null,
                    settings: {
                        apiKey: '',
                        model: AppConfig.DEFAULT_MODEL,
                        systemPrompt: AppConfig.DEFAULT_SYSTEM,
                        theme: 'light'
                    },
                    isGenerating: false
                };

                // DOM Elements
                this.elements = {
                    sidebar: document.getElementById('sidebar'),
                    sidebarOverlay: document.getElementById('sidebar-overlay'),
                    chatHistoryList: document.getElementById('chat-history-list'),
                    messagesList: document.getElementById('messages-list'),
                    welcomeScreen: document.getElementById('welcome-screen'),
                    userInput: document.getElementById('user-input'),
                    sendBtn: document.getElementById('send-btn'),
                    settingsModal: document.getElementById('settings-modal'),
                    modelDisplay: document.getElementById('model-display'),
                    themeIcon: document.getElementById('theme-icon'),
                    errorToast: document.getElementById('error-toast'),
                    displayUsername: document.getElementById('display-username'),
                    userAvatar: document.getElementById('user-avatar'),
                    welcomeUser: document.getElementById('welcome-user'),
                    inputs: {
                        apiKey: document.getElementById('setting-api-key'),
                        model: document.getElementById('setting-model'),
                        system: document.getElementById('setting-system')
                    }
                };
            }

            initializeUser(username) {
                this.username = username;
                this.storageKey = `ritegpt_data_${username}`;
                
                // UI Updates for User
                this.elements.displayUsername.innerText = username;
                this.elements.welcomeUser.innerText = username;
                this.elements.userAvatar.innerText = username.charAt(0).toUpperCase();

                this.loadState();
                this.applyTheme();
                this.renderSidebar();
                
                // Route to last chat or new chat
                if (this.state.chats.length > 0) {
                    this.loadChat(this.state.chats[0].id);
                } else {
                    this.createNewChat();
                }
            }

            // --- State Management ---

            loadState() {
                const storedData = localStorage.getItem(this.storageKey);

                if (storedData) {
                    const data = JSON.parse(storedData);
                    this.state.settings = { ...this.state.settings, ...data.settings };
                    this.state.chats = data.chats || [];
                } else {
                    // Defaults for new user
                     if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        this.state.settings.theme = 'dark';
                    }
                }
            }

            saveState() {
                const data = {
                    settings: this.state.settings,
                    chats: this.state.chats
                };
                localStorage.setItem(this.storageKey, JSON.stringify(data));
            }

            // --- UI Rendering ---

            applyTheme() {
                const html = document.documentElement;
                const icon = this.elements.themeIcon;
                
                if (this.state.settings.theme === 'dark') {
                    html.classList.add('dark');
                    icon.classList.replace('ph-moon', 'ph-sun');
                } else {
                    html.classList.remove('dark');
                    icon.classList.replace('ph-sun', 'ph-moon');
                }
            }

            toggleTheme() {
                this.state.settings.theme = this.state.settings.theme === 'dark' ? 'light' : 'dark';
                this.applyTheme();
                this.saveState();
            }

            toggleSidebar() {
                const sidebar = this.elements.sidebar;
                const overlay = this.elements.sidebarOverlay;
                const isMobile = window.innerWidth < 768;
                
                if (!isMobile) return; 

                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }

            renderSidebar() {
                this.elements.chatHistoryList.innerHTML = '';
                
                this.state.chats.forEach(chat => {
                    const btn = document.createElement('div');
                    const isActive = chat.id === this.state.currentChatId;
                    
                    btn.className = `group flex items-center justify-between p-2.5 rounded-lg cursor-pointer transition-colors text-sm ${
                        isActive 
                        ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 font-medium border border-indigo-100 dark:border-indigo-900/30' 
                        : 'hover:bg-slate-100 dark:hover:bg-slate-700/50 text-slate-700 dark:text-slate-300'
                    }`;
                    
                    btn.onclick = (e) => {
                        if(e.target.closest('.delete-btn')) return;
                        this.loadChat(chat.id);
                        if(window.innerWidth < 768) this.toggleSidebar();
                    };

                    btn.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <i class="ph ${isActive ? 'ph-chat-circle-text' : 'ph-chat-circle'} text-lg"></i>
                            <span class="truncate">${this.escapeHtml(chat.title)}</span>
                        </div>
                        <button onclick="app.deleteChat('${chat.id}')" class="delete-btn opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                            <i class="ph ph-trash"></i>
                        </button>
                    `;
                    
                    this.elements.chatHistoryList.appendChild(btn);
                });
            }

            renderMessages(messages) {
                this.elements.messagesList.innerHTML = '';
                
                if (messages.length === 0) {
                    this.elements.welcomeScreen.style.display = 'flex';
                    this.elements.messagesList.style.display = 'none';
                    return;
                }

                this.elements.welcomeScreen.style.display = 'none';
                this.elements.messagesList.style.display = 'flex';

                messages.forEach(msg => {
                    this.appendMessageToDOM(msg.role, msg.content, false);
                });
                
                this.scrollToBottom();
            }

            appendMessageToDOM(role, content, animate = true) {
                const div = document.createElement('div');
                const isUser = role === 'user';
                
                div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} ${animate ? 'animate-fade-in' : ''}`;
                
                const innerClass = isUser 
                    ? 'bg-rite-user dark:bg-rite-userDark rounded-2xl rounded-tr-sm shadow-sm'
                    : 'bg-transparent w-full';

                const icon = isUser ? '' : `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0 mt-1 mr-3 shadow-md border border-white/10">
                        <i class="ph ph-robot text-white text-sm"></i>
                    </div>
                `;

                // Parse Markdown safely
                const parsedContent = isUser 
                    ? this.escapeHtml(content) 
                    : DOMPurify.sanitize(marked.parse(content));

                div.innerHTML = `
                    <div class="flex max-w-[85%] md:max-w-[80%] ${isUser ? 'flex-row-reverse' : 'flex-row'}">
                        ${isUser ? '' : icon}
                        <div class="${innerClass} px-5 py-3 text-[15px] leading-7 text-slate-800 dark:text-slate-100 ${isUser ? '' : 'markdown-body w-full'}">
                            ${isUser ? content.replace(/\n/g, '<br>') : parsedContent}
                        </div>
                    </div>
                `;
                
                this.elements.messagesList.appendChild(div);
                this.scrollToBottom();
                return div;
            }

            scrollToBottom() {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            }

            // --- Chat Logic ---

            createNewChat() {
                const newChat = {
                    id: crypto.randomUUID(),
                    title: 'New Conversation',
                    messages: [],
                    timestamp: Date.now()
                };
                
                this.state.chats.unshift(newChat);
                this.state.currentChatId = newChat.id;
                this.saveState();
                this.renderSidebar();
                this.renderMessages([]);
                this.elements.userInput.focus();
                
                if(window.innerWidth < 768) {
                    const sidebar = this.elements.sidebar;
                    if (!sidebar.classList.contains('-translate-x-full')) {
                        this.toggleSidebar();
                    }
                }
            }

            loadChat(id) {
                this.state.currentChatId = id;
                const chat = this.state.chats.find(c => c.id === id);
                if (chat) {
                    this.renderMessages(chat.messages);
                }
                this.renderSidebar();
            }

            deleteChat(id) {
                this.state.chats = this.state.chats.filter(c => c.id !== id);
                
                if (this.state.currentChatId === id) {
                    if (this.state.chats.length > 0) {
                        this.loadChat(this.state.chats[0].id);
                    } else {
                        this.createNewChat();
                    }
                } else {
                    this.renderSidebar();
                }
                this.saveState();
            }

            async sendMessage() {
                if (this.state.isGenerating) return;

                const text = this.elements.userInput.value.trim();
                if (!text) return;
                
                if (!this.state.settings.apiKey) {
                    this.toggleSettings();
                    this.showError("Please set your OpenRouter API Key.");
                    return;
                }

                // UI Updates
                this.elements.userInput.value = '';
                this.elements.userInput.style.height = 'auto'; 
                this.state.isGenerating = true;
                this.elements.sendBtn.disabled = true;

                // Add User Message
                const currentChatIndex = this.state.chats.findIndex(c => c.id === this.state.currentChatId);
                const userMsg = { role: 'user', content: text };
                this.state.chats[currentChatIndex].messages.push(userMsg);
                
                // Update Title
                if (this.state.chats[currentChatIndex].messages.length === 1) {
                    this.state.chats[currentChatIndex].title = text.slice(0, 30) + (text.length > 30 ? '...' : '');
                    this.renderSidebar();
                }

                this.appendMessageToDOM('user', text);
                this.saveState();

                // Prepare API
                const messagesPayload = [
                    { role: 'system', content: this.state.settings.systemPrompt },
                    ...this.state.chats[currentChatIndex].messages
                ];

                // Create AI Placeholder
                const aiDiv = this.appendMessageToDOM('assistant', '<span class="cursor-blink">|</span>');
                const contentContainer = aiDiv.querySelector('.markdown-body');
                let fullResponse = "";

                try {
                    const response = await fetch(AppConfig.API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.settings.apiKey}`,
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'RiteGPT'
                        },
                        body: JSON.stringify({
                            model: this.state.settings.model,
                            messages: messagesPayload,
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'API Request Failed');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6);
                                if (dataStr === '[DONE]') continue;
                                
                                try {
                                    const data = JSON.parse(dataStr);
                                    const content = data.choices[0]?.delta?.content || "";
                                    fullResponse += content;
                                    contentContainer.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse + '<span class="cursor-blink">|</span>'));
                                    this.scrollToBottom();
                                } catch (e) { console.warn(e); }
                            }
                        }
                    }

                    contentContainer.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                    this.state.chats[currentChatIndex].messages.push({ role: 'assistant', content: fullResponse });
                    this.saveState();

                } catch (error) {
                    contentContainer.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
                    this.showError(error.message);
                } finally {
                    this.state.isGenerating = false;
                    this.elements.sendBtn.disabled = false;
                    this.elements.userInput.focus();
                }
            }

            // --- Settings & Utils ---

            toggleSettings() {
                const modal = this.elements.settingsModal;
                const isHidden = modal.classList.contains('hidden');
                
                if (isHidden) {
                    this.elements.inputs.apiKey.value = this.state.settings.apiKey;
                    this.elements.inputs.model.value = this.state.settings.model;
                    this.elements.inputs.system.value = this.state.settings.systemPrompt;
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }

            saveSettings() {
                this.state.settings.apiKey = this.elements.inputs.apiKey.value.trim();
                this.state.settings.model = this.elements.inputs.model.value.trim() || AppConfig.DEFAULT_MODEL;
                this.state.settings.systemPrompt = this.elements.inputs.system.value.trim() || AppConfig.DEFAULT_SYSTEM;
                
                this.saveState();
                this.elements.modelDisplay.innerText = `Model: ${this.state.settings.model}`;
                this.toggleSettings();
            }

            handleEnter(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if(window.innerWidth < 768) this.elements.userInput.blur();
                    this.sendMessage();
                }
            }

            showError(msg) {
                const toast = this.elements.errorToast;
                toast.innerText = msg;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            }

            escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
        }

        // Initialize Managers
        window.app = new ChatApp();
        window.auth = new AuthManager();
        
        document.addEventListener('DOMContentLoaded', () => {
            window.auth.init();
        });

    </script>
</body>
</html>
