<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RiteGPT | AI Interface</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        rite: { purple: '#9333ea', pink: '#db2777', dark: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        /* Subtle Logo Watermark */
        #chat-container::before {
            content: "";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 320px;
            background-image: url('https://i.postimg.cc/mD8mLRm2/rite-gpt.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.04; 
            pointer-events: none;
            z-index: 0;
        }

        .brand-text {
            background: linear-gradient(to right, #9333ea, #db2777);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .markdown-body pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin: 1rem 0; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }

        #loading { position: fixed; inset: 0; z-index: 9999; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dark #loading { background: #0f172a; }

        .cursor-blink { display: inline-block; width: 2px; height: 1.2em; background: #9333ea; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-white dark:bg-rite-dark text-slate-900 dark:text-slate-100 transition-colors">

    <div id="loading">
        <div class="w-10 h-10 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 brand-text text-xl">RiteGPT</p>
    </div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-50 dark:bg-rite-dark p-4 hidden">
        <div class="w-full max-w-md bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-8 border border-slate-200 dark:border-slate-700">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/mD8mLRm2/rite-gpt.png" class="w-16 mx-auto mb-4" alt="Logo">
                <h1 class="text-2xl font-bold brand-text">RiteGPT</h1>
                <p id="auth-title" class="text-slate-500 text-sm mt-1">Authorized Access Only</p>
            </div>

            <form id="auth-form" onsubmit="auth.handleSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Email</label>
                    <input type="email" id="auth-email" required placeholder="name@ritegpt.pro" class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-none focus:ring-2 focus:ring-purple-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Password</label>
                    <input type="password" id="auth-pass" required placeholder="••••••••" class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-none focus:ring-2 focus:ring-purple-500 outline-none transition-all">
                </div>
                <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-all shadow-lg shadow-purple-500/30">Sign In</button>
            </form>
            
            <div class="mt-6 flex flex-col items-center gap-3 text-sm">
                <button onclick="auth.toggleMode()" id="toggle-auth" class="text-purple-600 font-bold hover:underline">Create an account</button>
                <div class="w-full h-px bg-slate-200 dark:bg-slate-700 my-2"></div>
                <button onclick="auth.loginGuest()" class="text-slate-600 dark:text-slate-300 font-bold hover:text-purple-600 transition-colors">Continue as Guest</button>
            </div>
        </div>
    </div>

    <div id="app" class="flex h-screen w-full hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300">
            <div class="p-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/mD8mLRm2/rite-gpt.png" class="w-8">
                    <span class="brand-text text-lg">RiteGPT</span>
                </div>
                <button onclick="ui.toggleSidebar()" class="md:hidden p-2 text-slate-500"><i class="ph ph-x text-xl"></i></button>
            </div>

            <div class="p-4">
                <button onclick="app.newChat()" class="w-full flex items-center gap-3 px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl hover:shadow-md transition-all text-sm font-bold">
                    <i class="ph ph-plus-circle text-purple-600 text-xl"></i> New Chat
                </button>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto custom-scrollbar px-3 space-y-1"></div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800 space-y-2">
                <div id="user-info" class="flex items-center gap-3 px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl mb-2">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center text-white text-xs font-bold" id="user-initial">?</div>
                    <div class="flex-1 truncate text-[11px] font-bold" id="user-display">User</div>
                </div>
                
                <button onclick="app.openSettings()" id="settings-btn" class="hidden flex items-center gap-3 w-full px-3 py-2 text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg">
                    <i class="ph ph-sliders text-lg text-purple-600"></i> Global Config
                </button>

                <button onclick="ui.toggleTheme()" class="flex items-center gap-3 w-full px-3 py-2 text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg">
                    <i class="ph ph-moon text-lg dark:hidden"></i><i class="ph ph-sun text-lg hidden dark:block"></i> Theme
                </button>
                <button onclick="auth.logout()" class="flex items-center gap-3 w-full px-3 py-2 text-sm font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 rounded-lg">
                    <i class="ph ph-sign-out text-lg"></i> Logout
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative min-w-0 bg-white dark:bg-rite-dark">
            <header class="flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800 bg-white/80 dark:bg-rite-dark/80 backdrop-blur-md sticky top-0 z-30">
                <button onclick="ui.toggleSidebar()" class="md:hidden p-2"><i class="ph ph-list text-2xl"></i></button>
                <span id="chat-title-display" class="font-bold text-slate-400 text-[10px] uppercase tracking-widest">Active Session</span>
                <div class="w-8"></div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar relative">
                <div id="messages" class="max-w-3xl mx-auto p-4 md:p-8 space-y-8 pb-40"></div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 md:p-8 bg-gradient-to-t from-white via-white/95 dark:from-rite-dark dark:via-rite-dark/95">
                <div class="max-w-3xl mx-auto flex items-end gap-2 p-2 bg-slate-100 dark:bg-slate-800/50 rounded-3xl border-2 border-transparent focus-within:border-purple-500 transition-all shadow-xl">
                    <textarea id="user-input" rows="1" placeholder="Type a message..." class="flex-1 bg-transparent border-none focus:ring-0 px-4 py-3 resize-none text-sm md:text-base max-h-40 custom-scrollbar"></textarea>
                    <button id="send-btn" onclick="app.send()" class="p-3 bg-purple-600 text-white rounded-2xl hover:bg-purple-700 transition-all disabled:opacity-20">
                        <i class="ph ph-paper-plane-right-fill text-xl"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden p-4">
        <div class="w-full max-w-lg bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
            <h2 class="text-xl font-black mb-6 flex items-center gap-2"><i class="ph ph-key text-purple-600"></i> API Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">OpenRouter API Key</label>
                    <input type="password" id="admin-key-input" class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-none outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Model Path</label>
                    <input type="text" id="admin-model-input" class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border-none outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            <div class="mt-8 flex gap-3">
                <button onclick="app.closeSettings()" class="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-xl transition-all">Cancel</button>
                <button onclick="app.saveSettings()" class="flex-1 py-3 text-sm font-bold bg-purple-600 text-white rounded-xl shadow-lg hover:bg-purple-700">Save Config</button>
            </div>
        </div>
    </div>

    <script>
        /** RiteGPT Engine
         * Fixed: Blank login fields & restricted admin config
         */

        const ADMIN_EMAIL = "admin@ritegpt.pro";
        const ADMIN_PASS = "Kani@2211$";
        const STORE_KEY = "ritegpt_v3_config";
        
        // DEFAULT VALUES PROVIDED BY USER
        const DEFAULT_KEY = "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";
        const DEFAULT_MODEL = "nvidia/nemotron-nano-9b-v2:free";

        const auth = {
            mode: 'login',
            currentUser: null,
            init() {
                const session = sessionStorage.getItem('rite_session');
                if (session) { 
                    this.currentUser = JSON.parse(session); 
                    app.init(); 
                } else { 
                    document.getElementById('auth-screen').classList.remove('hidden'); 
                    document.getElementById('loading').style.display = 'none';
                }
            },
            handleSubmit(e) {
                e.preventDefault();
                const email = document.getElementById('auth-email').value.trim().toLowerCase();
                const pass = document.getElementById('auth-pass').value.trim();
                
                if (email === ADMIN_EMAIL.toLowerCase() && pass === ADMIN_PASS) {
                    this.login({ email: ADMIN_EMAIL, role: 'admin' });
                } else {
                    const users = JSON.parse(localStorage.getItem('rite_users') || '[]');
                    if (this.mode === 'login') {
                        const user = users.find(u => u.email === email && u.pass === pass);
                        if (user) this.login(user); else alert("Access Denied: Invalid Credentials");
                    } else {
                        if (email === ADMIN_EMAIL.toLowerCase()) return alert("Identifier restricted.");
                        if (users.find(u => u.email === email)) return alert("Account already exists.");
                        const newUser = { email, pass, role: 'user' };
                        users.push(newUser);
                        localStorage.setItem('rite_users', JSON.stringify(users));
                        this.login(newUser);
                    }
                }
            },
            login(user) {
                this.currentUser = user;
                sessionStorage.setItem('rite_session', JSON.stringify(user));
                document.getElementById('auth-screen').classList.add('hidden');
                app.init();
            },
            loginGuest() { this.login({ email: 'Guest Account', role: 'guest' }); },
            logout() { sessionStorage.removeItem('rite_session'); location.reload(); },
            toggleMode() {
                this.mode = this.mode === 'login' ? 'register' : 'login';
                document.getElementById('auth-title').innerText = this.mode === 'login' ? 'Authorized Access Only' : 'Create Account';
                document.getElementById('toggle-auth').innerText = this.mode === 'login' ? 'Create an account' : 'Already have an account? Sign In';
            }
        };

        const app = {
            config: { apiKey: DEFAULT_KEY, model: DEFAULT_MODEL, systemPrompt: 'You are RiteGPT.' },
            chats: [],
            currentChatId: null,
            isGenerating: false,

            init() {
                const saved = localStorage.getItem(STORE_KEY);
                if (saved) this.config = JSON.parse(saved);

                if (auth.currentUser.role !== 'guest') {
                    this.chats = JSON.parse(localStorage.getItem(`chats_${auth.currentUser.email}`) || '[]');
                }

                document.getElementById('app').classList.remove('hidden');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('user-display').innerText = auth.currentUser.email;
                document.getElementById('user-initial').innerText = auth.currentUser.email.charAt(0).toUpperCase();
                
                if (auth.currentUser.role === 'admin') {
                    document.getElementById('settings-btn').classList.remove('hidden');
                }

                this.renderChatList();
                this.newChat();

                const tx = document.getElementById('user-input');
                tx.addEventListener("input", function() {
                    this.style.height = "auto";
                    this.style.height = (this.scrollHeight) + "px";
                });
            },

            newChat() {
                this.currentChatId = Date.now();
                this.renderMessages([]);
                document.getElementById('chat-title-display').innerText = "Active Session";
            },

            renderChatList() {
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                this.chats.slice().reverse().forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-xs font-bold group ${this.currentChatId === chat.id ? 'bg-slate-200/50 dark:bg-slate-800 text-purple-600' : 'text-slate-400'}`;
                    div.innerHTML = `<i class="ph ph-chat-text"></i> <span class="flex-1 truncate">${chat.title}</span>`;
                    div.onclick = () => this.loadChat(chat.id);
                    list.appendChild(div);
                });
            },

            loadChat(id) {
                const chat = this.chats.find(c => c.id === id);
                if (chat) {
                    this.currentChatId = id;
                    this.renderMessages(chat.messages);
                    this.renderChatList();
                }
            },

            renderMessages(msgs) {
                const container = document.getElementById('messages');
                container.innerHTML = '';
                if (msgs.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-24 text-center">
                            <img src="https://i.postimg.cc/mD8mLRm2/rite-gpt.png" class="w-24 opacity-10 mb-6 grayscale" alt="Logo">
                            <h2 class="text-3xl font-black text-slate-100 dark:text-slate-800/40 tracking-tight">RITE GPT</h2>
                        </div>
                    `;
                    return;
                }
                msgs.forEach(m => this.appendMessage(m.role, m.content));
            },

            appendMessage(role, content) {
                const container = document.getElementById('messages');
                const empty = container.querySelector('div[class*="py-24"]');
                if (empty) empty.remove();

                const div = document.createElement('div');
                div.className = `flex gap-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const html = role === 'user' 
                    ? `<div class="bg-purple-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[85%] shadow-md text-sm font-medium">${content}</div>`
                    : `<div class="w-full">
                        <div class="flex items-center gap-2 mb-2">
                             <img src="https://i.postimg.cc/mD8mLRm2/rite-gpt.png" class="w-5">
                             <span class="text-[9px] font-black uppercase tracking-widest text-purple-600">RiteGPT AI</span>
                        </div>
                        <div class="markdown-body text-slate-700 dark:text-slate-300 text-sm leading-relaxed pl-7">${DOMPurify.sanitize(marked.parse(content))}</div>
                       </div>`;
                
                div.innerHTML = html;
                container.appendChild(div);
                container.parentElement.scrollTo({ top: container.parentElement.scrollHeight, behavior: 'smooth' });
                return div;
            },

            async send() {
                const input = document.getElementById('user-input');
                const content = input.value.trim();
                if (!content || this.isGenerating) return;
                
                this.isGenerating = true;
                input.value = '';
                input.style.height = "auto";
                document.getElementById('send-btn').disabled = true;

                let chat = this.chats.find(c => c.id === this.currentChatId);
                if (!chat) {
                    chat = { id: this.currentChatId, title: content.substring(0, 30), messages: [] };
                    this.chats.push(chat);
                }
                
                chat.messages.push({ role: 'user', content });
                this.appendMessage('user', content);

                const aiDiv = this.appendMessage('assistant', '<span class="cursor-blink"></span>');
                const aiTarget = aiDiv.querySelector('.markdown-body');
                let fullText = "";

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${this.config.apiKey}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: [{ role: "system", content: this.config.systemPrompt }, ...chat.messages],
                            stream: true
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        chunk.split('\n').forEach(line => {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    fullText += data.choices[0]?.delta?.content || "";
                                    aiTarget.innerHTML = DOMPurify.sanitize(marked.parse(fullText + '<span class="cursor-blink"></span>'));
                                } catch (e) {}
                            }
                        });
                    }
                    
                    aiTarget.innerHTML = DOMPurify.sanitize(marked.parse(fullText));
                    chat.messages.push({ role: 'assistant', content: fullText });
                    this.saveToDisk();
                    this.renderChatList();

                } catch (err) {
                    aiTarget.innerHTML = `<span class="text-red-500 font-bold">Error: Connection failed.</span>`;
                } finally {
                    this.isGenerating = false;
                    document.getElementById('send-btn').disabled = false;
                }
            },

            saveToDisk() {
                if (auth.currentUser.role === 'guest') return;
                localStorage.setItem(`chats_${auth.currentUser.email}`, JSON.stringify(this.chats));
            },

            openSettings() {
                document.getElementById('admin-key-input').value = this.config.apiKey;
                document.getElementById('admin-model-input').value = this.config.model;
                document.getElementById('settings-modal').classList.remove('hidden');
            },

            closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); },

            saveSettings() {
                this.config.apiKey = document.getElementById('admin-key-input').value.trim();
                this.config.model = document.getElementById('admin-model-input').value.trim();
                localStorage.setItem(STORE_KEY, JSON.stringify(this.config));
                this.closeSettings();
                alert("Global Configuration Saved.");
            }
        };

        const ui = {
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('rite_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            },
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        };

        window.onload = () => {
            if (localStorage.getItem('rite_theme') === 'dark') document.documentElement.classList.add('dark');
            auth.init();
        };

        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) {
                e.preventDefault(); app.send();
            }
        });
    </script>
</body>
</html>
