<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rite GPT | Universal AI Interface</title>
    <link rel="icon" type="image/png" href="./logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            500: '#8b5cf6', // Violet matching the logo vibe
                            600: '#7c3aed',
                            900: '#4c1d95',
                        },
                        dark: {
                            bg: '#131314',
                            surface: '#1e1f20',
                            input: '#282a2c'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Markdown Styles */
        .prose pre { background-color: #f1f5f9; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .dark .prose pre { background-color: #1e293b; }
        .prose code { font-family: monospace; color: #ef4444; background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .dark .prose code { color: #fca5a5; background: #374151; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        
        /* Watermark */
        .watermark-bg {
            background-image: url('./logo.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 300px;
            opacity: 0.03;
            pointer-events: none;
        }
        .dark .watermark-bg { opacity: 0.05; }

        /* Loader */
        #loading { position: fixed; inset: 0; z-index: 9999; background: white; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .loader-spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Blinking Cursor for Typing */
        .cursor-blink::after { content: '▋'; display: inline-block; animation: blink 1s infinite; color: #8b5cf6; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body class="h-full bg-white text-slate-900 dark:bg-dark-bg dark:text-slate-100 transition-colors duration-200 overflow-hidden">

    <div id="loading">
        <div class="loader-spinner mb-4"></div>
        <div class="text-slate-500 font-medium">Initializing Rite GPT...</div>
    </div>

    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-white dark:bg-dark-bg flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 text-center">
            <img src="./logo.png" alt="Rite GPT Logo" class="w-20 h-20 mx-auto mb-4 object-contain">
            <h1 class="text-2xl font-bold mb-2">Welcome to Rite GPT</h1>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">Secure, Universal AI Chat Interface</p>
            
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Email Address</label>
                    <input type="email" id="auth-email" required placeholder="name@example.com" 
                           class="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-dark-input focus:outline-none focus:ring-2 focus:ring-brand-500 transition-all">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Password</label>
                    <input type="password" id="auth-password" placeholder="••••••••" 
                           class="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-dark-input focus:outline-none focus:ring-2 focus:ring-brand-500 transition-all">
                </div>
                <button type="submit" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg shadow-lg transition-transform active:scale-95">
                    Continue
                </button>
            </form>
            
            <div class="mt-4 flex justify-between items-center text-sm">
                <button id="guest-btn" class="text-slate-500 hover:text-brand-600 underline">Continue as Guest</button>
                <button id="forgot-pass-btn" class="text-slate-500 hover:text-brand-600">Forgot Password?</button>
            </div>
            <p class="mt-6 text-xs text-slate-400">By continuing, you verify that you are authorized to access this interface.</p>
        </div>
    </div>

    <div id="app" class="hidden h-full flex flex-row relative">
        
        <aside id="sidebar" class="bg-slate-50 dark:bg-dark-surface w-72 h-full flex flex-col border-r border-slate-200 dark:border-slate-700 absolute md:relative z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
            <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="./logo.png" class="w-8 h-8 object-contain">
                    <span class="font-bold text-lg tracking-tight">Rite GPT</span>
                </div>
                <button id="close-sidebar" class="md:hidden text-slate-500 hover:text-slate-800 dark:hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="px-4 mb-2">
                <button id="new-chat-btn" class="w-full flex items-center gap-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-sm font-medium py-3 px-4 rounded-full transition-colors">
                    <i class="fa-solid fa-plus text-brand-500"></i>
                    <span>New Chat</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-2 py-2 space-y-1" id="chat-history-list">
                </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-brand-600 flex items-center justify-center text-white font-bold text-xs">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="text-sm font-medium truncate" id="user-display-email">Guest</div>
                    </div>
                    <button id="settings-trigger" class="text-slate-500 hover:text-brand-600 transition-colors" title="Settings">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

        <main class="flex-1 flex flex-col h-full relative watermark-bg">
            
            <header class="h-14 flex items-center justify-between px-4 border-b border-transparent">
                <div class="flex items-center gap-3">
                    <button id="menu-btn" class="md:hidden text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400 cursor-pointer" id="model-display-header">
                        <span>Rite GPT 1.0</span>
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="theme-toggle" class="text-slate-500 hover:text-brand-600 transition-colors">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 scroll-smooth">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center opacity-100 transition-opacity duration-300">
                    <div class="w-16 h-16 bg-gradient-to-br from-brand-500 to-pink-500 rounded-2xl flex items-center justify-center mb-6 shadow-lg">
                        <i class="fa-solid fa-pen-nib text-3xl text-white"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-pink-600">
                        Hello, <span id="welcome-name">User</span>
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md">
                        How can I help you today?
                    </p>
                </div>
                </div>

            <div class="w-full p-4 bg-gradient-to-t from-white via-white to-transparent dark:from-dark-bg dark:via-dark-bg absolute bottom-0 z-10">
                <div class="max-w-3xl mx-auto">
                    <div class="relative flex items-end gap-2 bg-slate-100 dark:bg-dark-surface border border-slate-200 dark:border-slate-600 rounded-3xl p-2 shadow-sm focus-within:ring-2 focus-within:ring-brand-500/50 transition-all">
                        
                        <button id="sys-prompt-btn" class="p-3 text-slate-400 hover:text-brand-500 rounded-full transition-colors hidden" title="System Prompt">
                            <i class="fa-solid fa-robot"></i>
                        </button>

                        <textarea id="user-input" rows="1" class="w-full bg-transparent border-none focus:ring-0 resize-none py-3 px-2 max-h-32 text-slate-800 dark:text-slate-100 placeholder-slate-400 text-base" placeholder="Ask anything..."></textarea>
                        
                        <button id="send-btn" class="p-3 bg-brand-600 hover:bg-brand-700 text-white rounded-full transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <p class="text-[10px] text-slate-400">Rite GPT can make mistakes. Consider checking important information.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-pulse-fast-once">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Settings</h3>
                <button id="close-settings" class="text-slate-400 hover:text-slate-800 dark:hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-semibold mb-2">OpenRouter API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="setting-api-key" placeholder="sk-or-..." class="flex-1 p-2 rounded border dark:border-slate-600 bg-slate-50 dark:bg-dark-input text-sm">
                        <button id="toggle-key-vis" class="p-2 text-slate-500"><i class="fa-solid fa-eye"></i></button>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Key is stored locally in your browser.</p>
                </div>

                <div id="admin-model-setting" class="hidden">
                    <label class="block text-sm font-semibold mb-2 text-brand-500">
                        <i class="fa-solid fa-lock mr-1"></i> Admin Model Override
                    </label>
                    <input type="text" id="setting-model" class="w-full p-2 rounded border dark:border-slate-600 bg-slate-50 dark:bg-dark-input text-sm font-mono">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">System Prompt</label>
                    <textarea id="setting-sys-prompt" rows="3" class="w-full p-2 rounded border dark:border-slate-600 bg-slate-50 dark:bg-dark-input text-sm" placeholder="You are a helpful assistant..."></textarea>
                </div>

                <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                    <h4 class="text-red-500 text-sm font-bold mb-2">Danger Zone</h4>
                    <button id="clear-all-data" class="text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-2 rounded border border-red-200 transition-colors">
                        Clear All Chat History
                    </button>
                    <button id="logout-btn" class="ml-2 text-sm text-slate-500 hover:bg-slate-100 px-3 py-2 rounded border border-slate-200 transition-colors">
                        Log Out
                    </button>
                </div>
            </div>
            
            <div class="p-4 bg-slate-50 dark:bg-dark-input flex justify-end">
                <button id="save-settings" class="bg-brand-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-brand-700 transition-colors">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const DEFAULT_API_KEY = "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";
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
        const ADMIN_EMAIL = "admin@ritegpt.pro";
        const ADMIN_EMAIL_ALT = "admin@ritegpt.com";
        
        let state = {
            userEmail: null,
            isAdmin: false,
            chats: [],
            currentChatId: null,
            apiKey: DEFAULT_API_KEY,
            model: DEFAULT_MODEL,
            systemPrompt: "You are Rite GPT, a helpful, honest, and expert AI assistant.",
            theme: 'light'
        };

        // --- DOM ELEMENTS ---
        const els = {
            loading: document.getElementById('loading'),
            authScreen: document.getElementById('auth-screen'),
            app: document.getElementById('app'),
            loginForm: document.getElementById('login-form'),
            authEmail: document.getElementById('auth-email'),
            guestBtn: document.getElementById('guest-btn'),
            forgotPassBtn: document.getElementById('forgot-pass-btn'),
            userDisplay: document.getElementById('user-display-email'),
            welcomeName: document.getElementById('welcome-name'),
            
            // Sidebar
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuBtn: document.getElementById('menu-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar'),
            newChatBtn: document.getElementById('new-chat-btn'),
            historyList: document.getElementById('chat-history-list'),
            
            // Chat
            chatContainer: document.getElementById('chat-container'),
            emptyState: document.getElementById('empty-state'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            modelHeader: document.getElementById('model-display-header'),
            themeToggle: document.getElementById('theme-toggle'),

            // Settings
            settingsModal: document.getElementById('settings-modal'),
            settingsTrigger: document.getElementById('settings-trigger'),
            closeSettings: document.getElementById('close-settings'),
            saveSettings: document.getElementById('save-settings'),
            settingApiKey: document.getElementById('setting-api-key'),
            settingModel: document.getElementById('setting-model'),
            settingSysPrompt: document.getElementById('setting-sys-prompt'),
            adminModelDiv: document.getElementById('admin-model-setting'),
            clearDataBtn: document.getElementById('clear-all-data'),
            logoutBtn: document.getElementById('logout-btn'),
            toggleKeyVis: document.getElementById('toggle-key-vis')
        };

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            applyTheme();
            
            // Artificial delay to show branding
            setTimeout(() => {
                els.loading.style.display = 'none';
                if(state.userEmail) {
                    initApp();
                } else {
                    els.authScreen.classList.remove('hidden');
                }
            }, 800);
        });

        function loadState() {
            const stored = localStorage.getItem('ritegpt_state');
            if(stored) {
                const parsed = JSON.parse(stored);
                state = { ...state, ...parsed };
                // Ensure default key if missing
                if(!state.apiKey) state.apiKey = DEFAULT_API_KEY; 
            }
        }

        function saveState() {
            localStorage.setItem('ritegpt_state', JSON.stringify(state));
        }

        function initApp() {
            els.authScreen.classList.add('hidden');
            els.app.classList.remove('hidden');
            els.app.classList.add('flex'); // Ensure flex layout
            
            els.userDisplay.textContent = state.userEmail || "Guest";
            els.welcomeName.textContent = state.userEmail ? state.userEmail.split('@')[0] : "Guest";
            
            // Admin Check
            state.isAdmin = (state.userEmail === ADMIN_EMAIL || state.userEmail === ADMIN_EMAIL_ALT);
            
            renderHistory();
            if(state.chats.length === 0) {
                createNewChat();
            } else if (state.currentChatId) {
                loadChat(state.currentChatId);
            } else {
                createNewChat();
            }
        }

        // --- AUTH LOGIC ---
        els.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = els.authEmail.value;
            if(email) {
                state.userEmail = email;
                saveState();
                initApp();
            }
        });

        els.guestBtn.addEventListener('click', () => {
            state.userEmail = "Guest";
            saveState();
            initApp();
        });

        els.forgotPassBtn.addEventListener('click', () => {
            alert("A password reset link has been sent to your email address (Simulated).");
        });

        els.logoutBtn.addEventListener('click', () => {
            state.userEmail = null;
            state.isAdmin = false;
            saveState();
            location.reload();
        });

        // --- THEME LOGIC ---
        function applyTheme() {
            const html = document.documentElement;
            const icon = els.themeToggle.querySelector('i');
            
            if(state.theme === 'dark') {
                html.classList.add('dark');
                icon.className = 'fa-solid fa-sun';
            } else {
                html.classList.remove('dark');
                icon.className = 'fa-solid fa-moon';
            }
        }

        els.themeToggle.addEventListener('click', () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            saveState();
            applyTheme();
        });

        // --- SIDEBAR LOGIC ---
        function toggleSidebar() {
            const isClosed = els.sidebar.classList.contains('-translate-x-full');
            if(isClosed) {
                els.sidebar.classList.remove('-translate-x-full');
                els.sidebarOverlay.classList.remove('hidden');
            } else {
                els.sidebar.classList.add('-translate-x-full');
                els.sidebarOverlay.classList.add('hidden');
            }
        }

        els.menuBtn.addEventListener('click', toggleSidebar);
        els.closeSidebarBtn.addEventListener('click', toggleSidebar);
        els.sidebarOverlay.addEventListener('click', toggleSidebar);

        // --- CHAT MANAGEMENT ---
        function createNewChat() {
            const id = Date.now().toString();
            const newChat = {
                id: id,
                title: "New Chat",
                messages: [],
                timestamp: Date.now()
            };
            state.chats.unshift(newChat);
            state.currentChatId = id;
            saveState();
            renderHistory();
            loadChat(id);
            if(window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile
        }

        els.newChatBtn.addEventListener('click', createNewChat);

        function deleteChat(e, id) {
            e.stopPropagation();
            if(!confirm("Delete this chat?")) return;
            state.chats = state.chats.filter(c => c.id !== id);
            if(state.currentChatId === id) {
                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
            }
            saveState();
            renderHistory();
            if(state.currentChatId) loadChat(state.currentChatId);
            else {
                els.chatContainer.innerHTML = '';
                els.chatContainer.appendChild(els.emptyState);
                els.emptyState.style.display = 'flex';
            }
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer text-sm transition-colors ${isActive ? 'bg-brand-100 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300' : 'hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300'}`;
                div.onclick = () => loadChat(chat.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 truncate">
                        <i class="fa-regular fa-message ${isActive ? 'text-brand-500' : 'text-slate-400'}"></i>
                        <span class="truncate w-32">${chat.title}</span>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 p-1" onclick="deleteChat(event, '${chat.id}')">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                els.historyList.appendChild(div);
            });
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            if(!chat) return;

            // Clear container but keep empty state hidden
            els.chatContainer.innerHTML = '';
            els.emptyState.style.display = 'none';

            if(chat.messages.length === 0) {
                els.chatContainer.appendChild(els.emptyState);
                els.emptyState.style.display = 'flex';
            } else {
                chat.messages.forEach(msg => appendMessageToDOM(msg.role, msg.content, false));
                scrollToBottom();
            }
            
            // Mobile: Close sidebar
            if(window.innerWidth < 768 && !els.sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        }

        // --- MESSAGING LOGIC ---
        function appendMessageToDOM(role, content, isStreaming = false) {
            const isUser = role === 'user';
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const avatar = isUser ? 
                `<div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center flex-shrink-0 text-slate-600 dark:text-slate-300"><i class="fa-solid fa-user"></i></div>` :
                `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-brand-500 to-purple-500 flex items-center justify-center flex-shrink-0 text-white shadow-md"><i class="fa-solid fa-pen-nib text-xs"></i></div>`;

            const bubbleClass = isUser ? 
                `bg-slate-100 dark:bg-slate-800 rounded-2xl rounded-tr-sm px-5 py-3 max-w-[85%] md:max-w-[70%]` : 
                `bg-transparent w-full max-w-full pl-2`;

            let innerContent = isUser ? 
                `<div class="text-sm md:text-base whitespace-pre-wrap">${content}</div>` :
                `<div class="prose dark:prose-invert max-w-none text-sm md:text-base leading-relaxed ${isStreaming ? 'cursor-blink' : ''}"></div>`;

            msgDiv.innerHTML = `
                <div class="flex gap-4 max-w-4xl ${isUser ? 'flex-row-reverse' : 'flex-row'} w-full">
                    ${avatar}
                    <div class="${bubbleClass}">
                        <div class="font-bold text-xs mb-1 opacity-50 ${isUser ? 'text-right' : 'text-left'}">${isUser ? 'You' : 'Rite GPT'}</div>
                        ${innerContent}
                    </div>
                </div>
            `;

            els.chatContainer.appendChild(msgDiv);
            
            if(!isUser) {
                const contentDiv = msgDiv.querySelector('.prose');
                // Use Marked to parse markdown safely
                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
                return contentDiv; // Return element for streaming updates
            }
        }

        function scrollToBottom() {
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
        }

        // --- API & STREAMING ---
        async function handleSend() {
            const text = els.userInput.value.trim();
            if(!text) return;

            els.userInput.value = '';
            els.userInput.style.height = 'auto'; // Reset height
            els.emptyState.style.display = 'none';

            // 1. Add User Message
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            appendMessageToDOM('user', text);
            scrollToBottom();
            saveState();

            // 2. Prepare AI Container
            const aiContentDiv = appendMessageToDOM('assistant', '', true); // true = typing cursor
            let aiResponse = "";
            let fullResponse = "";

            els.sendBtn.disabled = true;

            try {
                // Build history for context (limit to last 10 messages for token saving)
                const context = chat.messages.slice(-10).map(m => ({ role: m.role, content: m.content }));
                // Add System Prompt
                if(state.systemPrompt) {
                    context.unshift({ role: 'system', content: state.systemPrompt });
                }

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "HTTP-Referer": window.location.href,
                        "X-Title": "Rite GPT",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: context,
                        stream: true
                    })
                });

                if(!response.ok) throw new Error("API Error");

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    
                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const jsonStr = line.slice(6);
                            if (jsonStr === "[DONE]") break;
                            try {
                                const json = JSON.parse(jsonStr);
                                const content = json.choices[0]?.delta?.content || "";
                                fullResponse += content;
                                // Update UI
                                aiContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                                scrollToBottom();
                            } catch (e) { console.error("Parse error", e); }
                        }
                    }
                }

                // Stream finished
                aiContentDiv.classList.remove('cursor-blink');
                
                // Save AI message
                chat.messages.push({ role: 'assistant', content: fullResponse });
                
                // Update Chat Title if it's the first message
                if(chat.messages.length <= 2) {
                   chat.title = text.slice(0, 30) + (text.length > 30 ? '...' : '');
                   renderHistory();
                }
                
                saveState();

            } catch (error) {
                aiContentDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}. Please check your API Key in settings.</span>`;
                aiContentDiv.classList.remove('cursor-blink');
            } finally {
                els.sendBtn.disabled = false;
                els.userInput.focus();
            }
        }

        els.sendBtn.addEventListener('click', handleSend);
        els.userInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // Auto-resize textarea
        els.userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // --- SETTINGS LOGIC ---
        els.settingsTrigger.addEventListener('click', () => {
            els.settingApiKey.value = state.apiKey;
            els.settingModel.value = state.model;
            els.settingSysPrompt.value = state.systemPrompt;
            
            // Admin Check for Settings
            if(state.isAdmin) {
                els.adminModelDiv.classList.remove('hidden');
            } else {
                els.adminModelDiv.classList.add('hidden');
            }
            
            els.settingsModal.classList.remove('hidden');
        });

        els.closeSettings.addEventListener('click', () => {
            els.settingsModal.classList.add('hidden');
        });

        els.saveSettings.addEventListener('click', () => {
            state.apiKey = els.settingApiKey.value.trim() || DEFAULT_API_KEY;
            state.systemPrompt = els.settingSysPrompt.value.trim();
            
            if(state.isAdmin) {
                state.model = els.settingModel.value.trim() || DEFAULT_MODEL;
            }
            
            saveState();
            els.settingsModal.classList.add('hidden');
            // Show toast or confirmation (optional, simplistic here)
            alert("Settings Saved!");
        });
        
        els.clearDataBtn.addEventListener('click', () => {
            if(confirm("Are you sure? This deletes ALL history locally.")) {
                state.chats = [];
                state.currentChatId = null;
                saveState();
                location.reload();
            }
        });

        els.toggleKeyVis.addEventListener('click', (e) => {
            e.preventDefault();
            const type = els.settingApiKey.type === 'password' ? 'text' : 'password';
            els.settingApiKey.type = type;
        });

    </script>
</body>
</html>
