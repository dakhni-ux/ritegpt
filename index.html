<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RiteGPT</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<style>
body { height:100vh; overflow:hidden; }
</style>
</head>
<body class="bg-gray-100">

<!-- LOADER -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white">
    <div class="text-xl font-bold">RiteGPT</div>
</div>

<!-- AUTH SCREEN -->
<div id="auth-screen" class="hidden flex items-center justify-center h-full">
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">

<h2 class="text-2xl font-bold mb-4 text-center">RiteGPT Login</h2>

<form id="login-form" class="space-y-3" onsubmit="auth.login(event)">
<input id="login-email" type="text" placeholder="Email" required class="w-full p-2 border rounded">
<input id="login-password" type="password" placeholder="Password" required class="w-full p-2 border rounded">
<button class="w-full bg-indigo-600 text-white p-2 rounded">Login</button>
<div class="text-right text-sm">
<a href="#" onclick="auth.showReset()" class="text-indigo-600">Forgot Password?</a>
</div>
</form>

<form id="register-form" class="hidden space-y-3" onsubmit="auth.register(event)">
<input id="reg-email" type="text" placeholder="Email" required class="w-full p-2 border rounded">
<input id="reg-password" type="password" placeholder="Password" required class="w-full p-2 border rounded">
<button class="w-full bg-gray-800 text-white p-2 rounded">Register</button>
</form>

<form id="reset-form" class="hidden space-y-3" onsubmit="auth.resetPassword(event)">
<input id="reset-email" type="text" placeholder="Enter your email" required class="w-full p-2 border rounded">
<input id="new-password" type="password" placeholder="New password" required class="w-full p-2 border rounded">
<button class="w-full bg-red-600 text-white p-2 rounded">Reset Password</button>
</form>

<div class="text-center mt-4 text-sm">
<a href="#" onclick="auth.toggle()" class="text-indigo-600">Switch Login/Register</a>
</div>

<div id="auth-error" class="text-red-500 text-center mt-2 hidden"></div>

<button onclick="auth.guestLogin()" class="w-full mt-4 bg-green-600 text-white p-2 rounded">
Continue as Guest
</button>

</div>
</div>

<!-- APP -->
<div id="app" class="hidden h-full flex flex-col">

<div class="flex justify-between items-center p-3 bg-indigo-600 text-white">
<div id="username-display"></div>
<div>
<button id="admin-settings-btn" onclick="app.openSettings()" class="hidden mr-3">Admin Settings</button>
<button onclick="auth.logout()">Logout</button>
</div>
</div>

<div id="chat-area" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>

<div class="p-3 bg-gray-200 flex">
<textarea id="message-input" class="flex-1 p-2 rounded border"></textarea>
<button onclick="app.send()" class="ml-2 bg-indigo-600 text-white px-4 rounded">Send</button>
</div>

</div>

<!-- ADMIN SETTINGS -->
<div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
<div class="bg-white p-6 rounded w-full max-w-md">
<h3 class="font-bold text-lg mb-4">Admin API Settings</h3>
<input id="admin-api" placeholder="OpenRouter API Key" class="w-full p-2 border mb-2 rounded">
<input id="admin-model" placeholder="Model Name" class="w-full p-2 border mb-2 rounded">
<textarea id="admin-system" placeholder="System Prompt" class="w-full p-2 border mb-3 rounded"></textarea>
<button onclick="app.saveAdminSettings()" class="bg-indigo-600 text-white p-2 rounded w-full">Save</button>
<button onclick="app.closeSettings()" class="mt-2 text-gray-500 w-full">Cancel</button>
</div>
</div>

<script>
const CONFIG = {
ADMIN_EMAIL: "admin@ritegpt.pro",
USERS_KEY: "ritegpt_users",
SESSION_KEY: "ritegpt_session",
GLOBAL_KEY: "ritegpt_global_settings",
API_URL: "https://openrouter.ai/api/v1/chat/completions",
DEFAULT_MODEL: "deepseek/deepseek-r1:free",
DEFAULT_SYSTEM: "You are RiteGPT assistant."
};

/* ================= AUTH ================= */
class Auth {
init(){
const user = localStorage.getItem(CONFIG.SESSION_KEY);
setTimeout(()=>{
document.getElementById("loading").style.display="none";
if(user){ this.start(user); }
else{ document.getElementById("auth-screen").classList.remove("hidden"); }
},500);
}

getUsers(){
return JSON.parse(localStorage.getItem(CONFIG.USERS_KEY)||"{}");
}

saveUsers(users){
localStorage.setItem(CONFIG.USERS_KEY,JSON.stringify(users));
}

register(e){
e.preventDefault();
const email = reg-email.value.toLowerCase();
const pass = reg-password.value;
let users=this.getUsers();
if(users[email]) return this.error("User exists");
users[email]={password:pass};
this.saveUsers(users);
this.start(email);
}

login(e){
e.preventDefault();
const email=login-email.value.toLowerCase();
const pass=login-password.value;
let users=this.getUsers();
if(!users[email]||users[email].password!==pass)
return this.error("Invalid login");
this.start(email);
}

guestLogin(){
this.start("guest");
}

resetPassword(e){
e.preventDefault();
const email=reset-email.value.toLowerCase();
const newPass=new-password.value;
let users=this.getUsers();
if(!users[email]) return this.error("User not found");
users[email].password=newPass;
this.saveUsers(users);
alert("Password updated!");
this.toggle();
}

start(user){
localStorage.setItem(CONFIG.SESSION_KEY,user);
document.getElementById("auth-screen").classList.add("hidden");
document.getElementById("app").classList.remove("hidden");
username-display.innerText=user;
if(user===CONFIG.ADMIN_EMAIL)
admin-settings-btn.classList.remove("hidden");
app.init(user);
}

logout(){
localStorage.removeItem(CONFIG.SESSION_KEY);
location.reload();
}

toggle(){
login-form.classList.toggle("hidden");
register-form.classList.toggle("hidden");
reset-form.classList.add("hidden");
}

showReset(){
login-form.classList.add("hidden");
register-form.classList.add("hidden");
reset-form.classList.remove("hidden");
}

error(msg){
auth-error.innerText=msg;
auth-error.classList.remove("hidden");
}
}

/* ================= APP ================= */
class App{
init(user){
this.user=user;
this.isGuest=(user==="guest");
this.storageKey="ritegpt_data_"+user;
this.load();
this.render();
}

load(){
if(this.isGuest){ this.data=[]; return; }
this.data=JSON.parse(localStorage.getItem(this.storageKey)||"[]");
}

save(){
if(this.isGuest) return;
localStorage.setItem(this.storageKey,JSON.stringify(this.data));
}

render(){
chat-area.innerHTML="";
this.data.forEach(m=>{
chat-area.innerHTML+=`<div><b>${m.role}:</b> ${DOMPurify.sanitize(marked.parse(m.content))}</div>`;
});
}

getGlobal(){
return JSON.parse(localStorage.getItem(CONFIG.GLOBAL_KEY)||"{}");
}

async send(){
let msg=message-input.value.trim();
if(!msg) return;
this.data.push({role:"user",content:msg});
this.render();
this.save();
message-input.value="";

let settings=this.getGlobal();
if(!settings.apiKey) return alert("Admin must set API key.");

const res=await fetch(CONFIG.API_URL,{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+settings.apiKey
},
body:JSON.stringify({
model:settings.model||CONFIG.DEFAULT_MODEL,
messages:[
{role:"system",content:settings.systemPrompt||CONFIG.DEFAULT_SYSTEM},
...this.data
]
})
});
const data=await res.json();
let reply=data.choices?.[0]?.message?.content||"Error";
this.data.push({role:"assistant",content:reply});
this.render();
this.save();
}

openSettings(){
admin-modal.classList.remove("hidden");
let g=this.getGlobal();
admin-api.value=g.apiKey||"";
admin-model.value=g.model||"";
admin-system.value=g.systemPrompt||"";
}

closeSettings(){
admin-modal.classList.add("hidden");
}

saveAdminSettings(){
if(this.user!==CONFIG.ADMIN_EMAIL) return alert("Admin only.");
localStorage.setItem(CONFIG.GLOBAL_KEY,JSON.stringify({
apiKey:admin-api.value,
model:admin-model.value,
systemPrompt:admin-system.value
}));
alert("Saved!");
this.closeSettings();
}
}

const auth=new Auth();
const app=new App();

document.addEventListener("DOMContentLoaded",()=>auth.init());
</script>

</body>
</html>
